<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>React build 时为何会要用到 JDK? - That's the Way It Is</title><link rel=icon type=image/png href=/posts/img/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:description" content="构建时使用 JDK 做什么？"><meta name=twitter:description content="构建时使用 JDK 做什么？"><meta name=description content="构建时使用 JDK 做什么？"><meta name=description content="构建时使用 JDK 做什么？"><meta property="og:title" content="React build 时为何会要用到 JDK? | That's the Way It Is"><meta name=twitter:title content="React build 时为何会要用到 JDK? | That's the Way It Is"><meta property="og:image" content><meta itemprop=name content="React build 时为何会要用到 JDK? | That's the Way It Is"><meta name=application-name content="React build 时为何会要用到 JDK? | That's the Way It Is"><meta property="og:site_name" content><meta property="og:title" content="React build 时为何会要用到 JDK?"><meta property="og:description" content="构建时使用 JDK 做什么？"><meta property="og:type" content="article"><meta property="og:url" content="https://yrjkqq.github.io/posts/posts/13-react-with-java-why/"><meta property="article:published_time" content="2020-12-06T12:00:00+08:00"><meta property="article:modified_time" content="2020-12-06T12:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="React build 时为何会要用到 JDK?"><meta name=twitter:description content="构建时使用 JDK 做什么？"><link href=https://yrjkqq.github.io/posts/css/fonts.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://yrjkqq.github.io/posts/css/main.css><link rel=stylesheet type=text/css href=https://yrjkqq.github.io/posts/css/dark.css media="(prefers-color-scheme: dark)"></head><body><div class=content><header><div class=main><a href=https://yrjkqq.github.io/posts/>That's the Way It Is</a></div><nav><a href=/posts/tags>Tags</a>
<a href=/posts/posts>All</a></nav></header><main><article><div class=title><h1 class=title>React build 时为何会要用到 JDK?</h1><div class=meta>Posted on Dec 6, 2020</div></div><section class=body><p>React 官方<a href=https://reactjs.org/docs/how-to-contribute.html#contribution-prerequisites>贡献指南</a>中提到，运行 React 源代码需要使用到 JDK, 而且在使用 <code>yarn build</code> 时，如果没有安装 JDK 则会报错，这是为什么呢？要 Java 做什么呢？本文将一探究竟。</p><p><code>yarn build</code> 会运行 <code>node ./scripts/rollup/build.js</code> 脚本，运行完会输出: <img src=/posts/img/Snipaste_2020-12-06_18-08-44.png alt="yarn build output"></p><p>控制台会打印一个表格，这个表格是不是就是用到 Java 相关的库输出的呢？</p><p>这个表格是使用 <code>cli-table</code> 和 <code>chalk</code> 库实现的，与 Java 无关。<code>printResults</code> 方法会获取 table 类型的数据。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#75715e>// scripts\rollup\build.js
</span><span style=color:#75715e></span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>buildEverything</span>() {
  <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>
  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>Stats</span>.<span style=color:#a6e22e>printResults</span>());
  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>forcePrettyOutput</span>) {
    <span style=color:#a6e22e>Stats</span>.<span style=color:#a6e22e>saveResults</span>();
  }

  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>shouldExtractErrors</span>) {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>warn</span>(
      <span style=color:#e6db74>&#39;\nWarning: this build was created with --extract-errors enabled.\n&#39;</span> <span style=color:#f92672>+</span>
        <span style=color:#e6db74>&#39;this will result in extremely slow builds and should only be\n&#39;</span> <span style=color:#f92672>+</span>
        <span style=color:#e6db74>&#39;used when the error map needs to be rebuilt.\n&#39;</span>
    );
  }
}

<span style=color:#a6e22e>buildEverything</span>();
</code></pre></div><p><code>yarn build</code> 会同时输出 <code>react-native</code> 的包，猜测是构建 rn 库时需要用到 Java. 没有看到相关的代码。</p><p>全局搜索 java 关键字，发现有一个包 <code>google-closure-compiler</code> 的依赖包中有 java 字样。<a href=https://developers.google.com/closure/compiler/docs/gettingstarted_app>google-closure-compiler</a> 这个包会使用 java 将 JavaScript 代码进行压缩、优化、查找错误。所以需要安装 JDK.</p><p>在 React 源码中，使用 <code>scripts\rollup\plugins\closure-plugin.js</code> 这个 rollup 插件进行调用 closure-compiler。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#75715e>// scripts\rollup\build.js
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>closure</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./plugins/closure-plugin&#39;</span>);
<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getPlugins</span>(
    <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>    <span style=color:#75715e>// Apply dead code elimination and/or minification.
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>isProduction</span> <span style=color:#f92672>&amp;&amp;</span>
      <span style=color:#a6e22e>closure</span>(
        Object.<span style=color:#a6e22e>assign</span>({}, <span style=color:#a6e22e>closureOptions</span>, {
          <span style=color:#75715e>// Don&#39;t let it create global variables in the browser.
</span><span style=color:#75715e></span>          <span style=color:#75715e>// https://github.com/facebook/react/issues/10909
</span><span style=color:#75715e></span>          <span style=color:#a6e22e>assume_function_wrapper</span><span style=color:#f92672>:</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>isUMDBundle</span>,
          <span style=color:#a6e22e>renaming</span><span style=color:#f92672>:</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>shouldStayReadable</span>,
        })
      ),
    <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>}
<span style=color:#75715e>// scripts\rollup\plugins\closure-plugin.js
</span><span style=color:#75715e></span><span style=color:#e6db74>&#39;use strict&#39;</span>;

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ClosureCompiler</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;google-closure-compiler&#39;</span>).<span style=color:#a6e22e>compiler</span>;
<span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>promisify</span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;util&#39;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;fs&#39;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tmp</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;tmp&#39;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>writeFileAsync</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>promisify</span>(<span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>writeFile</span>);

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>compile</span>(<span style=color:#a6e22e>flags</span>) {
  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>closureCompiler</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ClosureCompiler</span>(<span style=color:#a6e22e>flags</span>);
    <span style=color:#a6e22e>closureCompiler</span>.<span style=color:#a6e22e>run</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>exitCode</span>, <span style=color:#a6e22e>stdOut</span>, <span style=color:#a6e22e>stdErr</span>) {
      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>stdErr</span>) {
        <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>stdOut</span>);
      } <span style=color:#66d9ef>else</span> {
        <span style=color:#a6e22e>reject</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#a6e22e>stdErr</span>));
      }
    });
  });
}
</code></pre></div></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/posts/tags/react>React</a></li></ul></nav></div></article></main><footer><hr>⚡️
2020 © yrjkqq | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></footer></div></body></html>