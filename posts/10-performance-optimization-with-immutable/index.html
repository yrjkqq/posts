<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>React 结合 Immutable 进行性能优化 - That's the Way It Is</title><link rel=icon type=image/png href=/posts/img/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:description" content="在 React 中使用 Immutable 进行极致得性能优化"><meta name=twitter:description content="在 React 中使用 Immutable 进行极致得性能优化"><meta name=description content="在 React 中使用 Immutable 进行极致得性能优化"><meta name=description content="在 React 中使用 Immutable 进行极致得性能优化"><meta property="og:title" content="React 结合 Immutable 进行性能优化 | That's the Way It Is"><meta name=twitter:title content="React 结合 Immutable 进行性能优化 | That's the Way It Is"><meta property="og:image" content><meta itemprop=name content="React 结合 Immutable 进行性能优化 | That's the Way It Is"><meta name=application-name content="React 结合 Immutable 进行性能优化 | That's the Way It Is"><meta property="og:site_name" content><meta property="og:title" content="React 结合 Immutable 进行性能优化"><meta property="og:description" content="在 React 中使用 Immutable 进行极致得性能优化"><meta property="og:type" content="article"><meta property="og:url" content="https://yrjkqq.github.io/posts/posts/10-performance-optimization-with-immutable/"><meta property="article:published_time" content="2020-11-19T00:08:00+08:00"><meta property="article:modified_time" content="2020-11-19T00:08:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="React 结合 Immutable 进行性能优化"><meta name=twitter:description content="在 React 中使用 Immutable 进行极致得性能优化"><link href=https://yrjkqq.github.io/posts/css/fonts.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://yrjkqq.github.io/posts/css/main.css><link rel=stylesheet type=text/css href=https://yrjkqq.github.io/posts/css/dark.css media="(prefers-color-scheme: dark)"></head><body><div class=content><header><div class=main><a href=https://yrjkqq.github.io/posts/>That's the Way It Is</a></div><nav><a href=/posts/tags>Tags</a>
<a href=/posts/posts>All</a></nav></header><main><article><div class=title><h1 class=title>React 结合 Immutable 进行性能优化</h1><div class=meta>Posted on Nov 19, 2020</div></div><section class=body><p>React 中虽然可以使用 <code>useMemo</code> <code>useCallback</code> <code>React.memo</code> 等 api 进行性能优化，但是如果是复杂场景下的复杂数据的更新，使用 <a href=https://immutable-js.github.io/immutable-js/>Immutable</a> 是更合适的。</p><p>在下面这个<a href="https://codesandbox.io/s/mystifying-pond-zx93e?file=/src/App.tsx">例子</a>中:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>React</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
<span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#34;./styles.css&#34;</span>;
<span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>List</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;immutable&#34;</span>;

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>ListChild</span>({ <span style=color:#a6e22e>names</span> }) {
  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>setV</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>React</span>.<span style=color:#a6e22e>useState</span>(<span style=color:#e6db74>&#34;a&#34;</span>);
  <span style=color:#66d9ef>return</span> (
    &lt;<span style=color:#f92672>div</span>&gt;
      {Date.<span style=color:#a6e22e>now</span>()}<span style=color:#f92672>-</span>{<span style=color:#a6e22e>names</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#34;,&#34;</span>)}
      &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>v</span>} <span style=color:#a6e22e>onChange</span><span style=color:#f92672>=</span>{(<span style=color:#a6e22e>e</span>) =&gt; <span style=color:#a6e22e>setV</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>value</span>)} /&gt;
    &lt;/<span style=color:#f92672>div</span>&gt;
  );
}

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>MemoListChild</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>React</span>.<span style=color:#a6e22e>memo</span>(<span style=color:#a6e22e>ListChild</span>, (<span style=color:#a6e22e>prevProps</span>, <span style=color:#a6e22e>nextProps</span>) =&gt; {
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>prevProps</span>.<span style=color:#a6e22e>names</span>.<span style=color:#a6e22e>equals</span>(<span style=color:#a6e22e>nextProps</span>.<span style=color:#a6e22e>names</span>);
});

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>App</span>() {
  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>setValue</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>React</span>.<span style=color:#a6e22e>useState</span>(<span style=color:#e6db74>&#34;&#34;</span>);
  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>names</span>, <span style=color:#a6e22e>setNames</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>React</span>.<span style=color:#a6e22e>useState</span>&lt;<span style=color:#f92672>List</span><span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#a6e22e>string</span>&gt;<span style=color:#f92672>&gt;</span>(<span style=color:#a6e22e>List</span>([]));

  <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handleChange</span>(<span style=color:#a6e22e>e</span>) {
    <span style=color:#a6e22e>setValue</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>value</span>);
    <span style=color:#a6e22e>setNames</span>(<span style=color:#a6e22e>List</span>([<span style=color:#e6db74>&#34;a&#34;</span>]));
  }

  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>memoListChild</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>React</span>.<span style=color:#a6e22e>useMemo</span>(() =&gt; &lt;<span style=color:#f92672>ListChild</span> <span style=color:#a6e22e>names</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>names</span>} /&gt;, [
    <span style=color:#a6e22e>names</span>
  ]);

  <span style=color:#66d9ef>return</span> (
    &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;App&#34;</span>&gt;
      &lt;<span style=color:#f92672>h1</span>&gt;<span style=color:#a6e22e>Hello</span> <span style=color:#a6e22e>CodeSandbox</span>&lt;/<span style=color:#f92672>h1</span>&gt;
      &lt;<span style=color:#f92672>h2</span>&gt;<span style=color:#a6e22e>Start</span> <span style=color:#a6e22e>editing</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>see</span> <span style=color:#a6e22e>some</span> <span style=color:#a6e22e>magic</span> <span style=color:#a6e22e>happen</span><span style=color:#f92672>!</span>&lt;/<span style=color:#f92672>h2</span>&gt;
      &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>value</span>} <span style=color:#a6e22e>onChange</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>handleChange</span>} /&gt;
      {<span style=color:#a6e22e>memoListChild</span>}
      &lt;<span style=color:#f92672>MemoListChild</span> <span style=color:#a6e22e>names</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>names</span>} /&gt;
    &lt;/<span style=color:#f92672>div</span>&gt;
  );
}

</code></pre></div><p>names 在输入框输入的过程中会不断的更新，每次调用 setNames 时都会生成一个新的对象。在使用 useMemo 时，因为浅比较，内部使用 Object.is 将前后两次的 names 的引用进行比较，自然是返回不相等，导致 memoListChild 变化，在 ListChild 中可以看到时间戳被更新了。</p><p>而如果使用不可变数据的专用方法 equals 在 React.memo() 的回调函数中进行比较，虽然重新渲染前后的 names 是不同的对象，但是实际内容是相等的，所以这里返回 true, 即可跳过子组件的更新，达到性能优化目的。</p><p><img src=/posts/img/Snipaste_2020-11-19_00-22-21.png alt=使用不可变数据前后变化></p><p>而在下面这个例子中，可以看到就算是浅比较也是可以避免更新的，这是由于 immutable 类型变量在使用类似 put set 等方法更新时会返回一个新的对象，但是如果实际内容没有进行更新时，出于性能考虑，仍然会返回原来的对象。所以使用 useMemo 进行浅比较时也返回相等，会跳过更新。示例代码如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>React</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
<span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#34;./styles.css&#34;</span>;
<span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Map</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;immutable&#34;</span>;

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>ListChild</span>({ <span style=color:#a6e22e>names</span> }) {
  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>setV</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>React</span>.<span style=color:#a6e22e>useState</span>(<span style=color:#e6db74>&#34;a&#34;</span>);
  <span style=color:#66d9ef>return</span> (
    &lt;<span style=color:#f92672>div</span>&gt;
      {Date.<span style=color:#a6e22e>now</span>()}<span style=color:#f92672>-</span>{<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>names</span>)}
      &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>v</span>} <span style=color:#a6e22e>onChange</span><span style=color:#f92672>=</span>{(<span style=color:#a6e22e>e</span>) =&gt; <span style=color:#a6e22e>setV</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>value</span>)} /&gt;
    &lt;/<span style=color:#f92672>div</span>&gt;
  );
}

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>MemoListChild</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>React</span>.<span style=color:#a6e22e>memo</span>(<span style=color:#a6e22e>ListChild</span>, (<span style=color:#a6e22e>prevProps</span>, <span style=color:#a6e22e>nextProps</span>) =&gt; {
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>prevProps</span>.<span style=color:#a6e22e>names</span>.<span style=color:#a6e22e>equals</span>(<span style=color:#a6e22e>nextProps</span>.<span style=color:#a6e22e>names</span>);
});

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>App</span>() {
  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>setValue</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>React</span>.<span style=color:#a6e22e>useState</span>(<span style=color:#e6db74>&#34;&#34;</span>);
  <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>setName</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>React</span>.<span style=color:#a6e22e>useState</span>&lt;<span style=color:#f92672>Map</span><span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#a6e22e>string</span><span style=color:#960050;background-color:#1e0010>,</span> <span style=color:#a6e22e>string</span>&gt;<span style=color:#f92672>&gt;</span>(<span style=color:#a6e22e>Map</span>({ <span style=color:#a6e22e>k</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;v&#34;</span> }));

  <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handleChange</span>(<span style=color:#a6e22e>e</span>) {
    <span style=color:#a6e22e>setValue</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>value</span>);
    <span style=color:#a6e22e>setName</span>(<span style=color:#a6e22e>name</span>.<span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#34;k&#34;</span>, <span style=color:#e6db74>&#34;vv&#34;</span>));
  }

  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>memoListChild</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>React</span>.<span style=color:#a6e22e>useMemo</span>(() =&gt; &lt;<span style=color:#f92672>ListChild</span> <span style=color:#a6e22e>names</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>name</span>} /&gt;, [<span style=color:#a6e22e>name</span>]);

  <span style=color:#66d9ef>return</span> (
    &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>className</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;App&#34;</span>&gt;
      &lt;<span style=color:#f92672>h1</span>&gt;<span style=color:#a6e22e>Hello</span> <span style=color:#a6e22e>CodeSandbox</span>&lt;/<span style=color:#f92672>h1</span>&gt;
      &lt;<span style=color:#f92672>h2</span>&gt;<span style=color:#a6e22e>Start</span> <span style=color:#a6e22e>editing</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>see</span> <span style=color:#a6e22e>some</span> <span style=color:#a6e22e>magic</span> <span style=color:#a6e22e>happen</span><span style=color:#f92672>!</span>&lt;/<span style=color:#f92672>h2</span>&gt;
      &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>value</span>} <span style=color:#a6e22e>onChange</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>handleChange</span>} /&gt;
      {<span style=color:#a6e22e>memoListChild</span>}
      &lt;<span style=color:#f92672>MemoListChild</span> <span style=color:#a6e22e>names</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>name</span>} /&gt;
    &lt;/<span style=color:#f92672>div</span>&gt;
  );
}
</code></pre></div><p><a href=https://immutable-js.github.io/immutable-js/>Immutable</a> 文档中对这种优化的说明：</p><blockquote><p>Note: As a performance optimization Immutable.js attempts to return the existing collection when an operation would result in an identical collection, allowing for using === reference equality to determine if something definitely has not changed. This can be extremely useful when used within a memoization function which would prefer to re-run the function if a deeper equality check could potentially be more costly. The === equality check is also used internally by Immutable.is and .equals() as a performance optimization.</p><p>处于性能优化考虑，Immutable 在更新时如果返回一个同样的集合，那么仍然会返回已存在的对象。这样在使用 === 比较时结果返回相等。</p></blockquote></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/posts/tags/react>React</a></li></ul></nav></div></article></main><footer><hr>⚡️
2020 © yrjkqq | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></footer></div></body></html>