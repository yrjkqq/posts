<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Node.js 中的 stream - That's the Way It Is</title><link rel=icon type=image/png href=/posts/img/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:description" content="流（stream）是 Node.js 中处理流式数据的抽象接口。"><meta name=twitter:description content="流（stream）是 Node.js 中处理流式数据的抽象接口。"><meta name=description content="流（stream）是 Node.js 中处理流式数据的抽象接口。"><meta name=description content="流（stream）是 Node.js 中处理流式数据的抽象接口。"><meta property="og:title" content="Node.js 中的 stream | That's the Way It Is"><meta name=twitter:title content="Node.js 中的 stream | That's the Way It Is"><meta property="og:image" content><meta itemprop=name content="Node.js 中的 stream | That's the Way It Is"><meta name=application-name content="Node.js 中的 stream | That's the Way It Is"><meta property="og:site_name" content><meta property="og:title" content="Node.js 中的 stream"><meta property="og:description" content="流（stream）是 Node.js 中处理流式数据的抽象接口。"><meta property="og:type" content="article"><meta property="og:url" content="https://yrjkqq.github.io/posts/posts/06-nodejs-stream/"><meta property="article:published_time" content="2018-09-08T19:41:00+08:00"><meta property="article:modified_time" content="2018-09-08T19:41:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Node.js 中的 stream"><meta name=twitter:description content="流（stream）是 Node.js 中处理流式数据的抽象接口。"><link href=https://yrjkqq.github.io/posts/css/fonts.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://yrjkqq.github.io/posts/css/main.css><link rel=stylesheet type=text/css href=https://yrjkqq.github.io/posts/css/dark.css media="(prefers-color-scheme: dark)"></head><body><div class=content><header><div class=main><a href=https://yrjkqq.github.io/posts/>That's the Way It Is</a></div><nav><a href=/posts/tags>Tags</a>
<a href=/posts/posts>All</a></nav></header><main><article><div class=title><h1 class=title>Node.js 中的 stream</h1><div class=meta>Posted on Sep 8, 2018</div></div><section class=body><p>stream 模块用于构建实现了流接口的对象。Node.js 提供了多种流对象。流可以是可读的、可写的、或者可读可写的。所有的流都是 EventEmitter 的实例。</p><p>流的类型：</p><ul><li>Writable 可写入数据的流，如 <code>fs.createWriteStream()</code></li><li>Readable 可读取数据的流，如 <code>fs.createReadStream()</code></li><li>Duplex 可读又可写的流，如 <code>net.Socket</code></li><li>Transform 在读写过程中可以修改或转换数据的 Duplex 流，如 <code>zlib.createDeflate()</code></li></ul><p>Node.js 创建的流都是运行在字符串和 Buffer (或 Uint8Array) 上。流的实现也可以使用其他类型的 JavaScript 值（除了 null）。</p><p>使用 stream 实现的 http 服务器:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>http</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;http&#34;</span>;

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>createServer</span>(<span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) {
  <span style=color:#75715e>// req 是一个 http.IncomingMessage 实例，是可读流
</span><span style=color:#75715e></span>  <span style=color:#75715e>// res 是一个 http.ServerResponse 实例，是可写流
</span><span style=color:#75715e></span>
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>body</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
  <span style=color:#75715e>// 接收数据为 utf8 字符串
</span><span style=color:#75715e></span>  <span style=color:#75715e>// 如果没有设置字符编码，则会接收到 Buffer 对象
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>setEncoding</span>(<span style=color:#e6db74>&#34;utf8&#34;</span>);

  <span style=color:#75715e>// 如果添加了监听器，则可读流会触发 &#39;data&#39; 事件
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;data&#34;</span>, (<span style=color:#a6e22e>chunk</span>) =&gt; {
    <span style=color:#a6e22e>body</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>chunk</span>;
  });

  <span style=color:#75715e>// &#39;end&#39; 事件表明整个请求体已被接受
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;end&#34;</span>, () =&gt; {
    <span style=color:#66d9ef>try</span> {
      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>body</span>);
      <span style=color:#75715e>// 响应信息给用户
</span><span style=color:#75715e></span>      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>write</span>(<span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>data</span>);
      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>end</span>();
    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>statusCode</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>400</span>;
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>end</span>(<span style=color:#e6db74>`错误：</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>message</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
    }
  });
});
<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#ae81ff>1337</span>);

<span style=color:#75715e>// $ curl localhost:1337 -d &#34;{}&#34;
</span><span style=color:#75715e>// object
</span><span style=color:#75715e>// $ curl localhost:1337 -d &#34;\&#34;foo\&#34;&#34;
</span><span style=color:#75715e>// string
</span><span style=color:#75715e>// $ curl localhost:1337 -d &#34;not json&#34;
</span><span style=color:#75715e>// 错误: Unexpected token o in JSON at position 1
</span><span style=color:#75715e></span>
</code></pre></div></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/posts/tags/node>Node</a></li></ul></nav></div></article></main><footer><hr>⚡️
2020 © yrjkqq | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></footer></div></body></html>